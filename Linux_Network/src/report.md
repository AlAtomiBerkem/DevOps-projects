# Linux Network <br>

---

## Part 1. ipcalc tool <br>

### 1.1. Networks and Masks <br>

- `` устанавливаем утилиту ipcalc $ sudo apt install ipcalc `` <br>
- `` узнаем ip 192.167.38.54/13 $ ipcalc 192.167.38.54/13 `` <br>
![1.1 ip](./images/1.1.png) <br>

- `` преобразования масок в префиксную /24, в обычную двоичную /15, перевод в 111111111.11111.11111.11110000 в обычную префиксную /28 `` <br>
![1.2](./images/1.2.png) <br>

- `` в сети 12.167.38.4 при масках: /8 hostmin - 12.0.0.1 hostmax - 12.255.255.254`` <br>
- `` в сети 12.167.38.4 при масках: /4 hostmin - 0.0.0.1 hostmax - 15.255.255.254`` <br>
- `` в сети 12.167.38.4 при масках: /255.255.254 hostmin - 12.167.38.1 hostmax - 12.167.39.254`` <br>
![1.3](./images/1.3.png) <br>
- `` в сети 12.167.38.4 при масках: /11111111.11111111.00000000.00000000 hostmin - 12.167.0.1 hostmax - 12.167.255.254`` <br>
![1.4](./images/1.4.png) <br>


### 1.2. localhost <br>

- ``194.34.23.100 - Нельзя `` <br>
- `` 127.0.0.2 - Можно, loopback `` <br>
- `` 127.1.0.1 - Можно, loopback `` <br>
- `` 128.0.0.1 - Нельзя `` <br>

![1.5](./images/1.5.png) <br>
![1.6](./images/1.6.png) <br>


### 1.3. Network ranges and segments <br>

- `` Чтобы определить, является ли IP-адрес публичным или частным, вы можете вручную сравнить его с известными диапазонами частных и публичных IP-адресов. Вот список стандартных приватных диапазонов IPv4: `` <br>

- `` 10.0.0.0 - 10.255.255.255 (CIDR /8) `` <br>
- `` 172.16.0.0 - 172.31.255.255 (CIDR /12) `` <br>
- `` 192.168.0.0 - 192.168.255.255 (CIDR /16) `` <br>
- `` Если IP-адрес находится внутри какого-либо из этих диапазонов, то он считается частным. В противном случае он считается публичным. `` <br>

- `` 10.0.0.45 - частный `` <br>
- `` 134.43.0.2 - публичный `` <br>
- `` 192.168.4.2 - частный `` <br>
- `` 172.20.250.4 - частный `` <br>
- `` 172.0.2.1 - публичный  `` <br>
- `` 192.172.0.1 - публичный `` <br>
- `` 172.68.0.2 - публичный `` <br>
- `` 172.16.255.255 - частный `` <br>
- `` 10.10.10.10 - частный`` <br>
- `` 192.169.168.1 - публичный `` <br>


- `` У сети 10.10.0.0/18 могут быть следующие IP-адреса: 10.10.0.2 | 10.10.10.10 | 10.10.1.255 `` <br>
![1.7](./images/1.7.png) <br>

---

## Part 2. Static routing between two machines <br>

- `` подняли 2 вертуальные машины ws1 и ws2 $ ip a , в virtual box в настройках сети выбираем 'внутренняя сеть' адаптер 2 `` <br>
![2.1](./images/2.1.png) <br>

- ``присвоили адресс и маску ws1 - 192.168.100.10 путем установкии net-tools и запуска команды $ sudo vim /etc/netplan/*.yaml`` <br>
![2.2](./images/2.2.png) <br>
- `` перезагружаем сеть командой $ sudo netplan apply `` <br>

- ``так же поступаем с 2й машиной `` <br>
![2.3](./images/2.3.png) <br>

- `` проверяем обе машины с помощью команды $ ip a `` <br>
![2.4](./images/2.4.png) <br>


### 2.1. Adding a static route manually <br>

- `` добовляем маршрут от ws2 к ws1 $ sudo ip r add 192.168.100.10 via 172.24.116.8 `` <br>
- `` добовляем маршрут от ws1 к ws2 $ sudo ip r add 172.24.116.8 via 192.168.100.10 `` <br>
- `` пропинговываем соединение между машинами `` <br>
![2.5](./images/2.5.png) <br>

### 2.2. Adding a static route with saving <br>

- ``добовляем статические маршруты от одной манины к другой `` <br>
![2.6](./images/2.6.png) <br>

- ``перезагружаем сетевые адаптеры $ sudo noteply apply `` <br>
- ``пропинговываем обе машины для проверки `` <br>
![2.7](./images/2.7.png) <br>


---

## Part 3. iperf3 utility <br>

- `` для того чтобы измерить скорость переачи данных от одной машины до другой будем использовать уилиту 'iperf3' `` <br>

- `` устанавливем iperf3 $ sudo apt install iperf3 `` <br>
![3.1](./images/3.1.png) <br>

- `` 8 MB/s - это 1 MB/s 100 MB/s - это 800000 KB/s 1 GB/s - это 1000 MB/s `` 
- `` запускаем сервер $ iperf3 -s `` <br>
- `` пингуем и проверяем соединение и скорость потока $ iperf3 -c 192.168.100.10 `` <br>
![3.2](./images/3.2.png) <br>


---

## Part 4. Network firewall <br>

- ``устанавливаем утилиту $ sudo apt-get install iptables `` <br>

- `` создаем файл $ sudo vim /etc/firewall.sh и прописыввем ему протокол, повторяем и на второй машине `` <br>
![4.1](./images/4.1.png) <br>

- `` проверяем соединение, пингуем `` <br>
![4.2](./images/4.2.pnges/) <br>


## Part 5. Static network routing <br>
- `` поднимаем 3 машины и 2 раутера (5 машин), далее в virtual box настраиваем сети к 3м машинам подключаем 2й адаптер, к 2м роутерам пониаем 1,2,3, роутер внетрення сеть и называем int1 и int2 `` <br>
![5.1](./images/5.1.png) <br>

### 5.1. Configuration of machine addresses <br>
- `` присвоили адреса r1 и r1 путем установкии net-tools $ sudo apt install net-tools iи запуска команды $ sudo vim /etc/netplan/*.yaml `` <br>
![5.2](./images/5.2.png) <br>
- `` перезагружаем роутеры $ sudo netplan apply `` <br>
- `` прокидываем адреса как указано в табличке `` <br>

- `` 3 настроеных роутера `` <br>
![5.3](./images/5.3.png) <br>

- `` $ ip -4 a пропинговываем 3 машины`` <br>
![5.4](./images/5.4.png) <br>

- `` ip -4 a r1 and r2 `` <br>
![5.5](./images/5.5.png) <br>

- `` пропинговываем  ws22 с ws21 и r1 с ws11`` <br>
![5.6](./images/5.6.png) <br>

### 5.2. Enabling IP forwarding.<br>
- `` выполняю команду $ sudo sysctl -w net.i `` <br>
![5.7](./images/5.7.png) <br>
- ``открываем  $ sudo vim /etc/sysctl.conf и добавляем в него net.ipv4.ip_forward = 1 `` <br>
![5.8](./images/5.8.png) <br>

### 5.3. Default route configuration <br>
- `` в файлах .yaml в 3х машинах меняем router - to на default сохроняем $ sudo netplan apply `` <br>
![5.9](./images/5.9.png) <br>

- `` проверяем $ ip r `` <br>
![5.10](./images/5.10.png) <br>

- `` правильно настроили роутер r2 и запускаем команду $ tcpdump -th -i eth1 enp0s3 `` <br>
![5.12](./images/5.12.png) <br>

- `` с машины ws11 пингуем роутер r2 командой  $ ping 10.100.0.12 `` <br>
![5.11](./images/5.11.png) <br>

- `` итоговый результат на задание 5.3 ``  <br>
![5.12](./images/5.13.png) <br>

### 5.4. Adding static routes <br>
- `` меняем конфигурацию сетей для настройки статических маршрутов, сохроняем изминения и перезапускаем $ sudo netplan apply `` <br>
![5.14](./images/5.14.png) <br>

- `` проверяем роутеры с помощью команды $ ip r `` <br>
- `` r1 `` <br>
![5.15](./images/5.15.png) <br>
- `` r2 `` <br>
![5.16](./images/5.16.png) <br>
- `` выполняем команды $ ip r list 10.10.0.0/18 и $ ip r list 0.0.0.0/0 `` <br>
![5.17](./images/5.17.png) <br>
- `` Маршрутизация и фильтрация трафика: В таблице маршрутизации, адрес 0.0.0.0 может использоваться для указания маршрута по умолчанию (default route). Когда сетевой пакет пытается найти подходящий маршрут в таблице маршрутизации и не находит точного совпадения с конкретным адресом, то он отправляется через маршрут по умолчанию, который может быть представлен как 0.0.0.0/0. `` <br>
### 5.5. Making a router list <br>
- `` устанавливаем утилиту $ sudo apt install traceroute `` <br>
- `` на роутере r1 вызываем команду $ sudo tcpdump -tnv -i enp0s8 `` <br>
![5.18.1](./images/5.18.1.png) <br>
- `` трасеруем маршрут с ws11 до ws 21 через команду $ traceroute -n 10.20.0.10 `` <br>
![5.18.2](./images/5.18.2.png) <br>

- `` Хост, с которого выполняется трассировка, отправляет пакеты на адрес назначения с разными показателями "времени жизни" TTL, начиная с 1 и постепенно его увеличивая. Каждый хост на пути к назначению отправляет пакет ICMP time exceeded in-transit, показывая, что пакет ещё не дошёл до адреса назначения. Адрес отправителя в данном пакете фиксируется в трассировке, как промежуточное звено на пути к адресу назначения. По умолчанию запросы от хоста-источника отправляются с помощью "проб"-пакетов (probes) по протоколу UDP, но с помощью ключей -I и -T можно заменить протокол на ICMP или TCP соответственно `` <br>

### 5.6. Using ICMP protocol in routing <br>
- `` для перехвата сетевого трафика c r1 вводим команду $ sudo tcpdumb -n -i enp0s8 icmp `` <br>
- `` c машины ws11 пингуем не существующий аддрес $ ping -c 1 10.30.0.111 `` <br>
- `` наблюдаем перехват роутером `` <br>
![5.18](./images/5.18.png) <br>


---

## Part 6. Dynamic IP configuration using DHCP <br>

- `` устанавливаем dhcp сервер $ sudo apt install isc-dhcp-server `` <br>
- `` открываем файл $ sudo vim /etc/dhcp/dhcpd.conf и меняем конфигурацию `` <br>
![6.1](./images/6.1.png) <br>
- `` $ sudo netplan apply $ reboot `` <br>
- `` открываем файл $ sudo vim /etc/resolv.conf и меняем nameserver на 8.8.8.8 `` <br>
![6.2](./images/6.2.png) <br>
- `` перезагружаем  DHCP службу командой $ sudo systemctl restart isc-dhcp-server `` <br>
- `` Посольку в сети появился DHCP-сервер, в файле конфигурации etc/netplan/00-installer-config.yaml изменим dhcp: true `` <br>
![6.3](./images/6.3.png) <br>
- `` в ws21 проверяем подключение с помощью команды ip a `` <br>
![6.4](./images/6.4.png) <br>
- `` пропинговываем ws22 с ws21 `` <br>
![6.5](./images/6.5.png) <br>
- `` для машины ws 11 добовляем macaddress и dscp4 true сохронем изменения и перезагружаем `` <br>
![6.6](./images/6.6.png) <br>
- `` так же устанавливаем для роутера r1 dhcp сервер $ sudo apt install isc-dhcp-server `` <br>
- `` проделываем все то же что и с роутером r2 `` <br>
- `` Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты `` <br>
![6.7](./images/6.7.png) <br>
![6.8](./images/6.8.png) <br>
![6.9](./images/6.9.png) <br>
- `` $ sudo dhclient -v `` <br>
![6.10](./images/6.10.png) <br>
- `` опция роутера ip-адрес [, ip-адрес...]; - адреса шлюзов для клиентской сети. Маршрутизаторы должны быть перечислены в порядке предпочтения. `` <br>
- ``опция IP-адрес серверов доменных имен [, IP-адрес...]; - Список DNS-серверов, доступных клиенту. Серверы должны быть перечислены в порядке предпочтения. `` <br>

---

## Part 7. NAT <br>

- `` устанавливаем apache server на машины ws22 and r1 командой $ sudo apt install apache2 `` <br>
- `` в виртуальной машине ws22 и роутере r2 заходим в файл $ sudo vim /etc/apache2/ports.conf `` <br>
![7.1](./images/7.1.png) <br>
![7.2](./images/7.2.png) <br>
- `` запускаем веб сервер apache2 командой $ service apache2 start на машинах ws22 and r1 `` <br>
![7.3](./images/7.3.png) <br>
- `` на машине r2 создаем фаервоол и прописываем в него правила, команда по созданию файла $ sudo vim /etc/firewall.sh `` <br>
- `` Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила: `` <br>
- ``1) удаление правил в таблице filter - iptables -F `` <br>
- ``2) удаление правил в таблице "NAT" - uptables -F -t nat `` <br>
- ``3) отбрасывать все маршрутизируемые пакеты -iptables --policy FORWARD DROP  `` <br>
![7.4](./images/7.4.png) <br>
- `` Запустим файл командами chmod +x /etc/firewall.sh и /etc/firewall.sh `` <br>
![7.5](./images/7.5.png) <br>
- `` проверяем соединение между ws22 и r1 командой ping `` <br>
![7.6](./images/7.6.png) <br>
![7.7](./images/7.7.png) <br>
-  `` FORWARD используется для обработки предназначенного для других серверов трафика, который не был создан на данном сервере. Эта цепочка в основном необходима для маршрутизации запросов на другие сервера. Эта цепочка в основном необходима для маршрутизации запросов на другие серверы. Поэтому при FORWARD DROP ws22 не пингуется c r1 `` <br>

- `` разрешаем маршрутизацию всех пакетов протокола ICMP на r2 `` <br>
![7.8](./images/7.8.png) <br>
- `` так же сохроняем изминения $ chmod +x /etc/firewall.sh и  sh /etc/firewall.sh `` <br>
- `` запускаем команду iptables -L для проверки выполнения протокола `` <br>
![7.9](./images/7.9.png) <br>
- `` пингуем между собой ws22 and r1 `` <br>
![7.10](./images/7.10.png) <br>
![7.11](./images/7.11.png) <br>
- `` добовляем еще 2 правила SNAT на порт машины r2 и добавить к веб серверу Apache запущенуму на ws 22 доступ из вне сети `` <br>
![7.12](./images/7.12.png) <br>
- `` t - указывает на используемую таблицу, p - указывает протокол (tcp, udp, upplite), s - указывает адрес источника пакета, d - указывает адрес назначения пакета, i - задает входящий сетевой интерфейс, 0 - указывает исходящий сетевой интерфейс:  `` <br>
- `` DNAT — подменяет адрес получателя в заголовке IP-пакета, основное применение — предоставление доступа к сервисам снаружи, находящимся внутри сети `` <br>
- `` SNAT — служит для преобразования сетевых адресов, применимо, когда за сервером находятся машины, которым необходимо предоставить доступ в Интернет, при этом от провайдера имеется статический IP-адрес `` <br> 

- `` так же сохроняем изминения и запускаем скрипт $ sudo chmod +x /etc/firewall.sh || sudo sh /etc/firewall.sh `` <br>

- `` для проверки соединения по TCP для SNAT. 1) отключаем сетевой интерфейс NAT в virtualbox, подключимся к серверу apache2 с ws22 на r1 командой telnet 10.100.0.11 80 так же проверяем соединение по TCP для DNAT с r1 подключаемся к серверу Apache на ws22 командой $ telnet 10.100.0.12 8080``<br
![7.13](./images/7.13.png) <br>

---

## Part 8. Bonus. Introduction to SSH Tunnels <br>

- `` запускаем фаервоол с правами из части 7 на r2 `` <br>
![8.1](./images/8.1.png) <br>
- `` sudo chmod +x /etc/firewall.sh `` <br>
- `` sudo sh /etc/firewall.sh `` <br>
![8.3](./images/8.3.png)

- `` меняем файл /etc/apache2/ports.conf изменяем строку listen 80 на listen localhost:80 `` <br>
![8.2](./images/8.2.png) <br>
- `` запускаем веб-сервер apache2 на ws22 на localhost `` <br>
![8.4](./images/8.4.png) <br>

- `` Воспользуeмся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21 `` <br>
![8.5](./images/8.5.png) <br>

- `` Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11 `` <br>
![8.6](./images/8.6.png) <br>

- `` Для проверки, сработало ли подключение в обоих предыдущих пунктах, выполняем telnet 127.0.0.1 [локальный порт] `` <br>
![8.7](./images/8.7.png) <br>